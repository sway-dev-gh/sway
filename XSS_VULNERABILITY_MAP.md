# XSS Vulnerability Map - SwayFiles Codebase

## Data Flow Diagram - Comment System (MOST CRITICAL PATH)

```
User Input
  |
  v
POST /api/workflow/sections/:id/comments
  |
  ├─ Receives: comment_text, comment_type, highlighted_text, line_number, parent_comment_id
  |
  ├─ VALIDATION: ❌ NO SANITIZATION (VULNERABLE)
  |  └─ Only uses .trim(), no XSS filtering applied
  |
  v
Database: section_comments table
  |
  ├─ Stores: comment_text (RAW, UNFILTERED)
  ├─ Stores: highlighted_text (RAW, UNFILTERED)
  |
  v
GET /api/workflow/sections/:id (Retrieve comments)
  |
  v
Frontend Component: SectionBlock.jsx
  |
  ├─ Receives: comment.content (UNSANITIZED FROM DB)
  ├─ Receives: comment.author (UNSANITIZED FROM DB)
  |
  ├─ RENDERING: ❌ NO ESCAPING
  |  ├─ Line 380: {comment.author}
  |  ├─ Line 394: {comment.content}
  |  └─ Uses JSX direct interpolation (no DOMPurify)
  |
  v
Browser Executes JavaScript ⚠️ XSS ATTACK SUCCEEDS
  |
  ├─ Cookie Theft
  ├─ Session Hijacking
  ├─ Credential Harvesting
  ├─ Malware Injection
  └─ Account Compromise
```

## Vulnerability Locations Map

### FRONTEND VULNERABILITIES

```
/web/src/components/
├── SectionBlock.jsx (CRITICAL - 4 XSS locations)
│   ├── Line 173: {section.title} ← XSS VULNERABLE
│   ├── Line 327: {section.content} ← XSS VULNERABLE
│   ├── Line 380: {comment.author} ← XSS VULNERABLE
│   └── Line 394: {comment.content} ← XSS VULNERABLE (Most critical)
│
├── RightPanel.jsx (HIGH - 2 XSS locations)
│   ├── Line 101: {activity.description} ← XSS VULNERABLE
│   └── Line 110: {activity.user} ← XSS VULNERABLE
│
├── EditRequestManager.jsx (MEDIUM - 1 XSS location)
│   └── Error display potentially vulnerable
│
└── EnhancedSectionBlock.jsx
    └── [CHECK FOR SAME VULNERABILITIES AS SectionBlock.jsx]
```

### BACKEND VULNERABILITIES

```
/backend/src/routes/
├── workflow.js (CRITICAL & HIGH - 3 major endpoints)
│   ├── POST /sections/:id/comments (Line 351)
│   │   ├── Input: comment_text ← NO SANITIZATION ⚠️ CRITICAL
│   │   ├── Input: highlighted_text ← NO VALIDATION ⚠️ MEDIUM
│   │   └── Stores to DB: RAW UNFILTERED
│   │
│   ├── POST /sections/:id/review (Line 238)
│   │   ├── Input: review_notes ← NO SANITIZATION ⚠️ HIGH
│   │   └── Stores to DB: RAW UNFILTERED
│   │
│   └── [No validation middleware applied to either endpoint]
│
├── activity.js (HIGH - 1 major function)
│   └── getActivityDescription() Lines 16-67
│       ├── Uses template strings: `${actorName} ...`
│       ├── Concatenates: ${metadata.shared_with}
│       ├── Concatenates: ${metadata.collaborator_email}
│       └── NO ESCAPING: Template strings unsafe ⚠️ HIGH
│
├── uploads.js (HIGH - 1 validation bypass)
│   └── validateName() Lines 147-154
│       ├── Regex: /<|>|&|"|'|script/i
│       ├── BYPASS: Case variation <IMG> or <svg/onload=>
│       └── Should use XSS library instead ⚠️ HIGH
│
└── reviews.js
    └── [Currently minimal implementation]
```

### MIDDLEWARE VULNERABILITIES

```
/backend/src/middleware/
├── validation.js (INCOMPLETE COVERAGE)
│   ├── Has XSS library imported: const xss = require('xss')
│   ├── Has sanitizeString() function defined
│   ├── Has validateProjects schema ✓
│   ├── MISSING: validateComments schema ❌
│   ├── MISSING: validateReviews schema ❌
│   └── Comment endpoints don't use validation middleware ❌
│
├── security.js (CONFIGURED WELL)
│   ├── Helmet.js: ✓ CSP headers set
│   ├── CORS: ✓ Properly configured
│   ├── HPP: ✓ HTTP parameter pollution blocked
│   └── Rate limiting: ✓ Applied
│
└── auth.js
    ├── Password hashing: ✓ Bcrypt
    └── JWT: ✓ Secure token generation
```

## User Input Flow Analysis

### High-Risk Input Paths

```
1. COMMENT CREATION (HIGHEST RISK)
   User Input
      ↓
   POST /api/workflow/sections/:id/comments
      ├─ Validation: NONE ❌
      ├─ Sanitization: NONE ❌
      └─ Storage: Database (comment_text, highlighted_text)
         ↓
   Database Query Result
      ↓
   Frontend: SectionBlock.jsx
      ├─ Escaping: NONE ❌
      ├─ HTML encoding: NONE ❌
      └─ Rendering: Direct JSX interpolation
         ↓
   Browser Renders HTML ⚠️ XSS EXECUTES

2. ACTIVITY FEED DISPLAY (HIGH RISK)
   logActivity() Function
      ↓
   Metadata with user-controlled values
      ↓
   getActivityDescription() Function
      ├─ Template strings: UNESCAPED ❌
      └─ Concatenation: Direct ❌
         ↓
   Frontend: RightPanel.jsx
      ├─ Escaping: NONE ❌
      └─ Rendering: Direct JSX
         ↓
   Browser Renders HTML ⚠️ XSS EXECUTES

3. REVIEW NOTES (HIGH RISK)
   User Input: review_notes
      ↓
   POST /api/workflow/sections/:id/review
      ├─ Validation: NONE ❌
      ├─ Sanitization: NONE ❌
      └─ Storage: Database (review_notes field)
         ↓
   If rendered to UI: Same path as comments ⚠️ RISK

4. FILE UPLOADER NAME (MEDIUM RISK)
   User Input: uploader name
      ↓
   POST /api/r/:code/upload
      ├─ Validation: Weak regex ❌ (can be bypassed)
      ├─ Sanitization: NONE (unless uploaded)
      └─ Storage: Database (uploader_name)
         ↓
   Frontend Display
      ├─ Escaping: Depends on component
      └─ Risk: MEDIUM (regex bypass possible)
```

## Vulnerability Severity Heat Map

```
CRITICAL (Do Immediately)
┌─────────────────────────────────────────┐
│ SectionBlock.jsx line 394 (comment.content)    │ HIGHEST PRIORITY
│ workflow.js line 384 (comment storage)         │ HIGHEST PRIORITY
└─────────────────────────────────────────┘

HIGH (Do in 1-2 weeks)
┌─────────────────────────────────────────┐
│ RightPanel.jsx line 101 (activity desc) │
│ RightPanel.jsx line 110 (activity user) │
│ SectionBlock.jsx line 173 (section title)      │
│ SectionBlock.jsx line 327 (section content)    │
│ workflow.js line 252 (review_notes)     │
│ uploads.js line 152 (name validation)   │
│ activity.js line 16-67 (metadata inject)       │
└─────────────────────────────────────────┘

MEDIUM (Do in 1 month)
┌─────────────────────────────────────────┐
│ Missing validateComments middleware │
│ highlighted_text validation        │
└─────────────────────────────────────────┘
```

## Attack Surface Analysis

### Most Exploitable Endpoints

1. **POST /api/workflow/sections/:id/comments** (EASIEST TO EXPLOIT)
   - No validation
   - No sanitization
   - Direct database storage
   - Affects all users viewing comments
   - **CVSS Score: 9.1 (CRITICAL)**

2. **POST /api/workflow/sections/:id/review** (HIGH IMPACT)
   - review_notes field unvalidated
   - Affects reviewers and project team
   - **CVSS Score: 7.5 (HIGH)**

3. **POST /api/r/:code/upload** (MEDIUM IMPACT)
   - Name validation can be bypassed
   - Affects shared file uploads
   - **CVSS Score: 6.2 (MEDIUM)**

## Dependency Analysis

### Good Security Dependencies

```
✓ xss v1.x (XSS library)
  └─ Used in validation.js but NOT applied to comments

✓ helmet (Security headers)
  └─ Properly configured in security.js

✓ bcrypt (Password hashing)
  └─ Used correctly in auth.js

✓ express-rate-limit (Rate limiting)
  └─ Applied to all endpoints

✓ cors (CORS handling)
  └─ Properly configured
```

### Missing Dependencies

```
❌ dompurify (Frontend sanitization)
  └─ Not installed, needed for React component sanitization
  └─ Would prevent comment rendering XSS

❌ helmet-csp (Advanced CSP)
  └─ Basic CSP implemented but could be stricter
```

## Remediation Priority Matrix

```
Impact \ Effort
         Easy    Medium   Hard
High    [C1]    [H1]    [H2]
        [C2]    [H3]    [H4]
        
Medium          [M1]    [M2]
                [M3]

C1: Install DOMPurify (Frontend)
C2: Sanitize comments (Backend)
H1: Sanitize activity descriptions
H2: Add comment validation schema
H3: Improve name validation
H4: Add XSS test suite
M1: Middleware coverage
M2: Enhanced components audit
M3: CSP upgrade
```

---

**Last Updated**: November 12, 2025
**Critical Vulnerabilities Found**: 2
**High Severity Vulnerabilities Found**: 5
**Medium Severity Vulnerabilities Found**: 2
